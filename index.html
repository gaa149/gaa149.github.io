<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>미니 RPG 게임</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #2c3e50;
            font-family: 'Arial', sans-serif;
        }
        #game-container {
            box-shadow: 0 0 20px rgba(0,0,0,0.3);
            position: relative;
        }
        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 14px;
            pointer-events: none;
            z-index: 1000;
            display: none;
        }
    </style>
</head>
<body>
    <div id="game-container"></div>
    <div class="tooltip"></div>

    <script>
        // 게임 설정
        const config = {
            type: Phaser.AUTO,
            parent: 'game-container',
            width: 800,
            height: 600,
            physics: {
                default: 'arcade',
                arcade: {
                    gravity: { y: 0 },
                    debug: false
                }
            },
            scene: {
                preload: preload,
                create: create,
                update: update
            },
            pixelArt: true
        };

        // 게임 인스턴스 생성
        const game = new Phaser.Game(config);

        // 게임 변수
        let player;
        let cursors;
        let enemies;
        let items;
        let attackKey;
        let inventoryKey;
        let attackArea;
        let healthText;
        let expText;
        let levelText;
        let map;
        let groundLayer;
        let wallsLayer;
        let spawnTimer;
        let damageTexts = [];
        let inventoryVisible = false;
        let inventoryContainer;
        let gameState = {
            health: 100,
            maxHealth: 100,
            score: 0,
            level: 1,
            exp: 0,
            expToNext: 100,
            attack: 10,
            defense: 5,
            isAttacking: false,
            attackCooldown: false,
            isInvulnerable: false,
            inventory: []
        };

        // 아이템 정의
        const ITEMS = {
            healthPotion: {
                name: '체력 포션',
                sprite: 'items',
                frame: 0,
                effect: (player) => {
                    const heal = 30;
                    gameState.health = Math.min(gameState.maxHealth, gameState.health + heal);
                    healthText.setText(`HP: ${gameState.health}/${gameState.maxHealth}`);
                    showDamageText(player.x, player.y, `+${heal}`, 0x00ff00);
                }
            },
            attackPotion: {
                name: '공격력 포션',
                sprite: 'items',
                frame: 1,
                effect: (player) => {
                    gameState.attack += 5;
                    showDamageText(player.x, player.y, 'Attack +5', 0xff9900);
                }
            },
            defensePotion: {
                name: '방어력 포션',
                sprite: 'items',
                frame: 2,
                effect: (player) => {
                    gameState.defense += 3;
                    showDamageText(player.x, player.y, 'Defense +3', 0x0099ff);
                }
            }
        };

        // 에셋 로드
        function preload() {
            // 캐릭터 스프라이트
            this.load.spritesheet('player', 
                'assets/sprites/rpg_heroes.png',
                { frameWidth: 48, frameHeight: 48 }
            );

            // 적 캐릭터
            this.load.spritesheet('slime',
                'assets/sprites/slime.png',
                { frameWidth: 32, frameHeight: 32 }
            );

            // 타일맵
            this.load.image('tiles',
                'assets/tilemaps/tiles/dungeon-16-16.png'
            );

            // 타일맵 JSON
            this.load.tilemapTiledJSON('map', 'assets/tilemaps/maps/dungeon.json');

            // 아이템
            this.load.spritesheet('items',
                'assets/sprites/items.png',
                { frameWidth: 32, frameHeight: 32 }
            );

            // UI 요소
            this.load.image('health-bar',
                'assets/sprites/health_bar.png'
            );

            // 공격 효과
            this.load.spritesheet('attack-effect',
                'assets/sprites/explosion.png',
                { frameWidth: 64, frameHeight: 64 }
            );
        }

        // UI 변수 추가
        let healthBar;
        let expBar;
        let minimapContainer;
        let tooltip;
        let statTexts = {};

        // 게임 초기화
        function create() {
            // 맵 생성
            createMap.call(this);

            // 애니메이션 설정
            createAnimations.call(this);

            // 플레이어 생성
            createPlayer.call(this);

            // 적 시스템 초기화
            createEnemySystem.call(this);

            // UI 설정
            createUI.call(this);

            // 아이템 시스템 초기화
            createItemSystem.call(this);

            // 인벤토리 키 설정
            inventoryKey = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.I);

            // 카메라 설정
            this.cameras.main.startFollow(player);
            this.cameras.main.setBounds(0, 0, map.widthInPixels, map.heightInPixels);

            // UI 초기화
            tooltip = document.querySelector('.tooltip');
        }

        // 맵 생성
        function createMap() {
            // 타일맵 생성
            map = this.make.tilemap({ key: 'map' });
            const tileset = map.addTilesetImage('dungeon', 'tiles');
            
            // 레이어 생성
            groundLayer = map.createLayer('Ground', tileset, 0, 0);
            wallsLayer = map.createLayer('Walls', tileset, 0, 0);
            
            // 충돌 설정
            wallsLayer.setCollisionByExclusion([-1]);
            
            // 월드 경계 설정
            this.physics.world.bounds.width = map.widthInPixels;
            this.physics.world.bounds.height = map.heightInPixels;
        }

        // 플레이어 생성
        function createPlayer() {
            // 플레이어 스프라이트 생성
            player = this.physics.add.sprite(400, 300, 'player');
            player.setCollideWorldBounds(true);
            player.setSize(32, 32);
            
            // 플레이어와 벽 충돌
            this.physics.add.collider(player, wallsLayer);
            
            // 공격 영역 설정
            attackArea = this.add.rectangle(0, 0, 40, 40, 0xff0000, 0);
            this.physics.add.existing(attackArea, true);
            attackArea.body.enable = false;
            
            // 키보드 입력 설정
            cursors = this.input.keyboard.createCursorKeys();
            attackKey = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.SPACE);
        }

        // 애니메이션 생성
        function createAnimations() {
            // 플레이어 애니메이션
            this.anims.create({
                key: 'walk-down',
                frames: this.anims.generateFrameNumbers('player', { start: 0, end: 3 }),
                frameRate: 8,
                repeat: -1
            });

            this.anims.create({
                key: 'walk-left',
                frames: this.anims.generateFrameNumbers('player', { start: 4, end: 7 }),
                frameRate: 8,
                repeat: -1
            });

            this.anims.create({
                key: 'walk-right',
                frames: this.anims.generateFrameNumbers('player', { start: 8, end: 11 }),
                frameRate: 8,
                repeat: -1
            });

            this.anims.create({
                key: 'walk-up',
                frames: this.anims.generateFrameNumbers('player', { start: 12, end: 15 }),
                frameRate: 8,
                repeat: -1
            });

            // 슬라임 애니메이션
            this.anims.create({
                key: 'slime-move',
                frames: this.anims.generateFrameNumbers('slime', { start: 0, end: 2 }),
                frameRate: 8,
                repeat: -1
            });

            // 공격 효과 애니메이션
            this.anims.create({
                key: 'attack',
                frames: this.anims.generateFrameNumbers('attack-effect', { start: 0, end: 5 }),
                frameRate: 15,
                repeat: 0
            });
        }

        // UI 생성
        function createUI() {
            const ui = this.add.container(0, 0);
            ui.setScrollFactor(0);

            // 상단 UI 배경
            const topUiBg = this.add.rectangle(400, 40, 760, 60, 0x000000, 0.5);
            ui.add(topUiBg);

            // 게임 제목
            const title = this.add.text(20, 16, 'RPG Game', {
                fontSize: '24px',
                fill: '#fff'
            });
            ui.add(title);

            // 체력바 배경
            const healthBarBg = this.add.rectangle(150, 40, 200, 20, 0x000000);
            ui.add(healthBarBg);

            // 체력바
            healthBar = this.add.rectangle(150, 40, 200, 20, 0xff0000);
            healthBar.setOrigin(0, 0.5);
            ui.add(healthBar);

            // 체력 텍스트
            healthText = this.add.text(150, 40, `${gameState.health}/${gameState.maxHealth}`, {
                fontSize: '16px',
                fill: '#fff'
            });
            healthText.setOrigin(0.5);
            ui.add(healthText);

            // 경험치바 배경
            const expBarBg = this.add.rectangle(400, 40, 200, 10, 0x000000);
            ui.add(expBarBg);

            // 경험치바
            expBar = this.add.rectangle(400, 40, 0, 10, 0x00ff00);
            expBar.setOrigin(0.5);
            ui.add(expBar);

            // 레벨 텍스트
            levelText = this.add.text(400, 20, `Level ${gameState.level}`, {
                fontSize: '16px',
                fill: '#fff'
            });
            levelText.setOrigin(0.5);
            ui.add(levelText);

            // 스탯 UI
            const stats = [
                { key: 'attack', label: '공격력', x: 600 },
                { key: 'defense', label: '방어력', x: 700 }
            ];

            stats.forEach(stat => {
                const text = this.add.text(stat.x, 40, `${stat.label}: ${gameState[stat.key]}`, {
                    fontSize: '16px',
                    fill: '#fff'
                });
                text.setOrigin(0.5);
                ui.add(text);
                statTexts[stat.key] = text;
            });

            // 미니맵
            createMinimap.call(this);
        }

        // 미니맵 생성
        function createMinimap() {
            const minimapSize = 150;
            minimapContainer = this.add.container(650, 450);
            minimapContainer.setScrollFactor(0);

            // 미니맵 배경
            const minimapBg = this.add.rectangle(0, 0, minimapSize, minimapSize, 0x000000, 0.7);
            minimapContainer.add(minimapBg);

            // 미니맵 테두리
            const border = this.add.rectangle(0, 0, minimapSize, minimapSize);
            border.setStrokeStyle(2, 0xffffff);
            minimapContainer.add(border);

            // 플레이어 표시
            const playerDot = this.add.circle(0, 0, 3, 0x00ff00);
            minimapContainer.add(playerDot);

            // 적 표시 (빨간 점)
            const enemyDots = [];
            
            // 미니맵 업데이트
            this.time.addEvent({
                delay: 100,
                callback: () => {
                    // 플레이어 위치 업데이트
                    const playerX = (player.x / map.widthInPixels) * minimapSize - minimapSize/2;
                    const playerY = (player.y / map.heightInPixels) * minimapSize - minimapSize/2;
                    playerDot.setPosition(playerX, playerY);

                    // 기존 적 점 제거
                    enemyDots.forEach(dot => dot.destroy());
                    enemyDots.length = 0;

                    // 적 위치 업데이트
                    enemies.children.entries.forEach(enemy => {
                        const enemyX = (enemy.x / map.widthInPixels) * minimapSize - minimapSize/2;
                        const enemyY = (enemy.y / map.heightInPixels) * minimapSize - minimapSize/2;
                        const dot = this.add.circle(enemyX, enemyY, 2, 0xff0000);
                        minimapContainer.add(dot);
                        enemyDots.push(dot);
                    });
                },
                loop: true
            });
        }

        // UI 업데이트
        function updateUI() {
            // 체력바 업데이트
            const healthPercent = gameState.health / gameState.maxHealth;
            healthBar.width = 200 * healthPercent;
            healthText.setText(`${gameState.health}/${gameState.maxHealth}`);

            // 경험치바 업데이트
            const expPercent = gameState.exp / gameState.expToNext;
            expBar.width = 200 * expPercent;
            levelText.setText(`Level ${gameState.level}`);

            // 스탯 텍스트 업데이트
            statTexts.attack.setText(`공격력: ${gameState.attack}`);
            statTexts.defense.setText(`방어력: ${gameState.defense}`);
        }

        // 아이템 시스템 생성
        function createItemSystem() {
            // 아이템 그룹 생성
            items = this.physics.add.group();
            
            // 아이템과 플레이어 충돌
            this.physics.add.overlap(player, items, collectItem, null, this);
            
            // 인벤토리 UI 생성
            createInventoryUI.call(this);
        }

        // 아이템 수집
        function collectItem(player, item) {
            item.destroy();
            
            const itemType = item.getData('type');
            gameState.inventory.push(itemType);
            
            // 인벤토리 UI 업데이트
            updateInventoryUI();
        }

        // 인벤토리 UI 생성
        function createInventoryUI() {
            inventoryContainer = this.add.container(400, 300);
            inventoryContainer.setScrollFactor(0);
            inventoryContainer.setVisible(false);
            
            // 배경
            const bg = this.add.rectangle(0, 0, 300, 400, 0x000000, 0.8);
            inventoryContainer.add(bg);
            
            // 제목
            const title = this.add.text(0, -180, '인벤토리', {
                fontSize: '24px',
                fill: '#fff'
            });
            title.setOrigin(0.5);
            inventoryContainer.add(title);
        }

        // 인벤토리 UI 업데이트
        function updateInventoryUI() {
            // 기존 아이템 UI 제거
            inventoryContainer.each(child => {
                if (child.type === 'Sprite') {
                    child.destroy();
                }
            });
            
            // 아이템 UI 추가
            gameState.inventory.forEach((itemType, index) => {
                const item = ITEMS[itemType];
                const x = (index % 5) * 50 - 100;
                const y = Math.floor(index / 5) * 50 - 100;
                
                const itemSprite = this.add.sprite(x, y, item.sprite, item.frame);
                inventoryContainer.add(itemSprite);
                
                // 아이템 클릭 이벤트
                itemSprite.setInteractive();
                itemSprite.on('pointerdown', () => {
                    item.effect(player);
                    gameState.inventory.splice(index, 1);
                    updateInventoryUI();
                });
                
                // 툴팁
                itemSprite.on('pointerover', () => {
                    tooltip.style.display = 'block';
                    tooltip.textContent = item.name;
                    tooltip.style.left = (itemSprite.x + 400) + 'px';
                    tooltip.style.top = (itemSprite.y + 300) + 'px';
                });
                
                itemSprite.on('pointerout', () => {
                    tooltip.style.display = 'none';
                });
            });
        }

        // 아이템 드롭
        function dropItem(x, y) {
            const itemTypes = ['healthPotion', 'attackPotion', 'defensePotion'];
            const randomType = itemTypes[Phaser.Math.Between(0, itemTypes.length - 1)];
            const item = ITEMS[randomType];
            
            const itemSprite = items.create(x, y, item.sprite, item.frame);
            itemSprite.setData('type', randomType);
        }

        // 적 시스템 생성
        function createEnemySystem() {
            // 적 그룹 생성
            enemies = this.physics.add.group();
            
            // 적과 벽 충돌
            this.physics.add.collider(enemies, wallsLayer);
            
            // 적과 플레이어 충돌
            this.physics.add.overlap(player, enemies, handleEnemyCollision, null, this);
            
            // 적과 공격 영역 충돌
            this.physics.add.overlap(attackArea, enemies, handleAttackHit, null, this);
            
            // 적 생성 타이머
            spawnTimer = this.time.addEvent({
                delay: 3000,
                callback: () => {
                    if (enemies.countActive(true) < 5) {
                        spawnEnemy.call(this);
                    }
                },
                loop: true
            });
        }

        // 적 생성
        function spawnEnemy() {
            const x = Phaser.Math.Between(100, map.widthInPixels - 100);
            const y = Phaser.Math.Between(100, map.heightInPixels - 100);
            
            const enemy = enemies.create(x, y, 'slime');
            enemy.setCollideWorldBounds(true);
            enemy.health = 30;
            enemy.anims.play('slime-move', true);
            
            // 적 AI
            this.time.addEvent({
                delay: 100,
                callback: () => {
                    if (enemy.active) {
                        // 플레이어 방향으로 이동
                        const angle = Phaser.Math.Angle.Between(enemy.x, enemy.y, player.x, player.y);
                        const speed = 50;
                        enemy.setVelocity(
                            Math.cos(angle) * speed,
                            Math.sin(angle) * speed
                        );
                    }
                },
                loop: true
            });
        }

        // 적과 플레이어 충돌 처리
        function handleEnemyCollision(player, enemy) {
            if (!gameState.isInvulnerable) {
                const damage = Math.max(5 - gameState.defense, 1);
                gameState.health -= damage;
                healthText.setText(`${gameState.health}/${gameState.maxHealth}`);
                healthBar.setScale(gameState.health / gameState.maxHealth, 1);
                
                showDamageText(player.x, player.y, `-${damage}`, 0xff0000);
                
                // 무적 시간
                gameState.isInvulnerable = true;
                this.time.delayedCall(1000, () => {
                    gameState.isInvulnerable = false;
                });
                
                // 플레이어 사망
                if (gameState.health <= 0) {
                    this.scene.restart();
                }
            }
        }

        // 공격 히트 처리
        function handleAttackHit(attackArea, enemy) {
            if (gameState.isAttacking) {
                enemy.health -= gameState.attack;
                showDamageText(enemy.x, enemy.y, `-${gameState.attack}`, 0xffff00);
                
                if (enemy.health <= 0) {
                    enemy.destroy();
                    
                    // 경험치 획득
                    gameState.exp += 10;
                    if (gameState.exp >= gameState.expToNext) {
                        levelUp.call(this);
                    }
                    expBar.setScale(gameState.exp / gameState.expToNext, 1);
                }
            }
        }

        // 레벨업
        function levelUp() {
            gameState.level++;
            gameState.exp = 0;
            gameState.expToNext = Math.floor(gameState.expToNext * 1.5);
            gameState.maxHealth += 20;
            gameState.health = gameState.maxHealth;
            gameState.attack += 5;
            gameState.defense += 2;
            
            levelText.setText(`Level ${gameState.level}`);
            healthText.setText(`${gameState.health}/${gameState.maxHealth}`);
            healthBar.setScale(1, 1);
            expBar.setScale(0, 1);
            
            // 스탯 텍스트 업데이트
            statTexts.attack.setText(`공격력: ${gameState.attack}`);
            statTexts.defense.setText(`방어력: ${gameState.defense}`);
            
            showDamageText(player.x, player.y, 'Level Up!', 0x00ff00);
        }

        // 데미지 텍스트 표시
        function showDamageText(x, y, text, color) {
            const damageText = this.add.text(x, y, text, {
                fontSize: '20px',
                fill: '#' + color.toString(16).padStart(6, '0')
            });
            damageText.setOrigin(0.5);
            
            this.tweens.add({
                targets: damageText,
                y: y - 50,
                alpha: 0,
                duration: 1000,
                onComplete: () => damageText.destroy()
            });
        }

        // 플레이어 사망
        function handlePlayerDeath() {
            // 게임 일시 정지
            this.scene.pause();
            
            // 게임 오버 텍스트
            const gameOverText = this.add.text(400, 300, 'Game Over', {
                fontSize: '64px',
                fill: '#ff0000',
                stroke: '#000',
                strokeThickness: 8
            });
            gameOverText.setOrigin(0.5);
            gameOverText.setScrollFactor(0);
            
            // 재시작 버튼
            const restartButton = this.add.text(400, 400, 'Restart', {
                fontSize: '32px',
                fill: '#fff',
                backgroundColor: '#000',
                padding: { x: 20, y: 10 }
            });
            restartButton.setOrigin(0.5);
            restartButton.setScrollFactor(0);
            restartButton.setInteractive();
            
            restartButton.on('pointerdown', () => {
                // 게임 상태 초기화
                gameState = {
                    health: 100,
                    maxHealth: 100,
                    score: 0,
                    level: 1,
                    exp: 0,
                    expToNext: 100,
                    attack: 10,
                    defense: 5,
                    isAttacking: false,
                    attackCooldown: false,
                    isInvulnerable: false,
                    inventory: [] // 인벤토리도 초기화
                };
                
                // 씬 재시작
                this.scene.restart();
            });
        }

        // 경험치 업데이트
        function updateExp() {
            if (gameState.exp >= gameState.expToNext) {
                levelUp();
            }
            expText.setText(`EXP: ${gameState.exp}/${gameState.expToNext}`);
        }

        // 레벨업 함수 수정
        function levelUp() {
            gameState.level++;
            gameState.exp -= gameState.expToNext;
            gameState.expToNext = Math.floor(gameState.expToNext * 1.5);
            gameState.maxHealth += 20;
            gameState.health = gameState.maxHealth;
            gameState.attack += 5;
            gameState.defense += 3;

            // UI 업데이트
            updateUI();
            
            // 레벨업 효과
            this.cameras.main.flash(500, 255, 255, 255);
            showLevelUpEffect.call(this);
        }

        // 레벨업 효과
        function showLevelUpEffect() {
            const levelUpText = this.add.text(player.x, player.y - 50, 'LEVEL UP!', {
                fontSize: '32px',
                fill: '#ffff00',
                stroke: '#000',
                strokeThickness: 4
            });
            levelUpText.setOrigin(0.5);

            this.tweens.add({
                targets: levelUpText,
                y: levelUpText.y - 50,
                alpha: 0,
                duration: 1000,
                ease: 'Power2',
                onComplete: () => levelUpText.destroy()
            });
        }

        // 공격 실행
        function attack() {
            if (gameState.attackCooldown) return;

            gameState.isAttacking = true;
            gameState.attackCooldown = true;

            // 공격 방향 설정
            let attackX = player.x;
            let attackY = player.y;
            let offsetX = 0;
            let offsetY = 0;

            if (player.anims.currentAnim) {
                switch(player.anims.currentAnim.key) {
                    case 'walk-left':
                        offsetX = -40;
                        break;
                    case 'walk-right':
                        offsetX = 40;
                        break;
                    case 'walk-up':
                        offsetY = -40;
                        break;
                    case 'walk-down':
                        offsetY = 40;
                        break;
                }
            }

            // 공격 영역 활성화
            attackArea.x = attackX + offsetX;
            attackArea.y = attackY + offsetY;
            attackArea.body.enable = true;

            // 공격 효과 생성
            let effect = this.add.sprite(attackArea.x, attackArea.y, 'attack-effect');
            effect.play('attack');
            effect.once('animationcomplete', () => {
                effect.destroy();
            });

            // 타이머 설정
            this.time.delayedCall(200, () => {
                gameState.isAttacking = false;
                attackArea.body.enable = false;
            });

            this.time.delayedCall(500, () => {
                gameState.attackCooldown = false;
            });
        }

        // 아이템 툴팁 표시
        function showTooltip(item, x, y) {
            tooltip.style.display = 'block';
            tooltip.style.left = x + 'px';
            tooltip.style.top = y + 'px';
            tooltip.textContent = item.name;
        }

        // 아이템 툴팁 숨기기
        function hideTooltip() {
            tooltip.style.display = 'none';
        }

        // 게임 업데이트 루프
        function update() {
            if (!player) return;
            
            // 플레이어 이동
            const speed = 200;
            
            if (cursors.left.isDown) {
                player.setVelocityX(-speed);
                player.anims.play('walk-left', true);
            } else if (cursors.right.isDown) {
                player.setVelocityX(speed);
                player.anims.play('walk-right', true);
            } else {
                player.setVelocityX(0);
            }
            
            if (cursors.up.isDown) {
                player.setVelocityY(-speed);
                if (!cursors.left.isDown && !cursors.right.isDown) {
                    player.anims.play('walk-up', true);
                }
            } else if (cursors.down.isDown) {
                player.setVelocityY(speed);
                if (!cursors.left.isDown && !cursors.right.isDown) {
                    player.anims.play('walk-down', true);
                }
            } else {
                player.setVelocityY(0);
            }
            
            // 플레이어가 멈춰있을 때 애니메이션 정지
            if (player.body.velocity.x === 0 && player.body.velocity.y === 0) {
                player.anims.stop();
            }
            
            // 공격
            if (attackKey.isDown && !gameState.attackCooldown) {
                attack();
            }
            
            // 인벤토리
            if (Phaser.Input.Keyboard.JustDown(inventoryKey)) {
                inventoryContainer.setVisible(!inventoryContainer.visible);
            }
        }
    </script>
</body>
</html>